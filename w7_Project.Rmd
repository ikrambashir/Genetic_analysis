---
title: 'Project RIL Population Z015'
author: "Bashir,I. (2022)"
date: "21/04/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Introduction:

you can explain the imprtance of the crop, the origin of the pop, the meaning of PH for maize and how rhe different qtl mapping appraoches might help us to understand the better genetic basis of a trait and guide breeding decisions.

## Material and Methods + Results

### Linkage map

```{r}
# install.packages("qtl")
library(qtl)
```

Loading data:

Similarly, we use the read.cross() function to load the data:

```{r}
maize <- read.cross(format="csv", file="data/population_Z015.csv", genotypes=c("0", "1", "2"), crosstype = "riself")
```

Data summary:

```{r}
summary(maize)
```

```{r}
geno.image(maize)
```

Chi_squared tests for segregation distoration

```{r}
gt.maize <- geno.table(maize)
gt.maize
head(gt.maize)
table(gt.maize$P.value <0.05)
table(gt.maize$P.value <0.05/totmar(maize))
```

```{r}
table(gt.maize$P.value <0.05)
```

```{r}
table(gt.maize$P.value <0.05/totmar(maize))
```

Estimation of the pairwise or two-point recombination fractions:

```{r}
maize <- est.rf(cross = maize)
dim(maize$rf)
plotRF(maize, col.scheme = "redblue")
```

Again, this heatmap presents both the estimates (above diagonal) and LOD scores (below diagonal). The\
heatmap shows more blue, colder colors for non-linked markers (i.e. r $\approx$ 0.5 and low LOD), and more red, warmer colors for the linked markers (i.e. r $<$ 0.35 and high ).\
With similar criteria used for the mouse data ( r $<$ 0.35 and LOD $>$ 3), we can now see how many groups are formed by with these markers:

## Marker grouping

```{r}
#max.rf <- 0.38
#kosambi <- function(r) (1/4)*log((1+(2*r))/(1-(2*r)))
#kosambi(r = max.rf)
```

NOooooo

```{r}
#(M <- totmar(maize)) # number of markers
#(num.pair <- choose(M, 2)) # number of marker pairs
#(min.lrt <- qchisq(1-(0.05/num.pair), 1))# min LRT to consider two markers linked
#(min.lod <- 0.2172 * min.lrt)

```

## Linkage groups

```{r}
maize <- formLinkageGroups(maize, max.rf=0.38, min.lod=6.25, reorgMarkers=TRUE)
summary(maize)
#table(maize[,2])
plotRF(maize, col.scheme = "redblue")

```

## Marker Ordering by Multidimensional Scale (MDS) by MDSMap + MAPpoly

MDSMap implements the MDS algorithm, and MAPpoly has a nice wrapper function called `mds_mappoly`. This function only needs the recombination fraction matrix estimated by R/qtl, and it returns a new order that can be used by `switch.order()` R/qtl function to yield a newly ordered linkage group.\
First, we need to install `MAPpoly package` and use the function below to get the order given by the MDS algorithm for a chosen linkage group. You need to run it first so it becomes available into R before you actually use it:

```{r}
library(mappoly)
```

```{r}
getMDSorder <- function(cross, chr){
  markers <- match(names(cross$geno[[chr]]$map), colnames(cross$rf))
  mat <- cross$rf[markers,markers]
  rec.mat <- lod.mat <- matrix(rep(NA, length(markers)^2), nrow =length(markers))
  colnames(rec.mat) <- colnames(lod.mat) <- rownames(rec.mat) <- rownames(lod.mat) <- colnames(mat)
  lod.mat[upper.tri(lod.mat)] <- mat[upper.tri(mat)]
  lod.mat[lower.tri(lod.mat)] <- t(lod.mat)[lower.tri(lod.mat)]#; image(lod.mat)
  rec.mat[lower.tri(rec.mat)] <- mat[lower.tri(mat)]
  rec.mat[upper.tri(rec.mat)] <- t(rec.mat)[upper.tri(rec.mat)]#; image(rec.mat)
  input.mat <- NULL
  input.mat$rec.mat <- rec.mat
  input.mat$lod.mat <- lod.mat
  mds.map <- mappoly::mds_mappoly(input.mat)
  mds.ord <- match(as.character(mds.map$locimap$locus), colnames(mat))
  return(mds.ord)
}
```

We'll create a new object called `maize.mds` which is a copy of our original cross object maize , so that we can update the ordering within `maize.mds` only. In addition, we'll create an empty object called `loglik.mds` to store the log-likelihood of the orderings obtained using MDS:

```{r}
maize.mds <- maize
loglike.mds <- c()
```

**Linkage group 1**

```{r}
for(c in 1:10) { #reodering markers into eacg of the 10 linkage groups
  mds.ord <- getMDSorder(cross = maize.mds, chr = c)
  maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
  plotRF(maize.mds, chr=c, col.scheme = "redblue")
}
save(maize.mds, file = "maize_015.RData")
```

Final map:

```{r}
c <- 1
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord, maxit = 10000, tol=1e-5)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))

```

**Linkage group 2**

```{r}
c <- 2
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 3**

```{r}
c <- 3
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 4**

```{r}
c <- 4
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 5**

```{r}
c <- 5
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 6**

```{r}
c <- 6
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 7**

```{r}
c <- 7
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 8**

```{r}
c <- 8
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 9**

```{r}
c <- 9
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

**Linkage group 10**

```{r}
c <- 10
mds.ord <- getMDSorder(cross = maize.mds, chr = c)
maize.mds <- switch.order(cross = maize.mds, chr=c, order=mds.ord)
plotRF(maize.mds, chr=c, col.scheme = "redblue")
(pull.map(maize.mds, chr = c))
(loglik.mds[c] <- attr(maize.mds$geno[[c]]$map, "loglik"))
```

```{r}
#knitr::kable(cbind(summaryMap(maize.mds), log.likelihood=c(loglik.mds, sum(loglik.mds))))
```

```{r}
#plotMap(maize.mds)
```

```{r}
#plotRF(maize.mds, col.scheme = "redblue")
```

```{r}
#save.image("maize15_mds.Rdata")
```

```{r}
summaryMap(maize015.mds)
plotMap(maize015.mds)
PlotRF(maize015.mds, col.scheme ="redblue")
```

#### **Assignment week 8:**

Used the linkage map to perform interval mapping (IM) for the trait "PlantHeight". Do not forget to run permutation tests to identify the LOD threshold to declare QTL at an alpha level of 0.05. Results for the QTL peak within each QTL region should be presented as a table showing QTL chromosome and location of its peak, their effects, associated LOD scores, and R-squared.

## QTL Mapping

Approximate critical values previously obtained from permutation tests (idealy, should be run separatly for each population):

```{r}
lod.mr <- 3.0
lod.im <- 3.0
lod.cim <- 7.4
penalties.mim <- c(main = 2.92, heavy = 4.21, light = 2.05)
```

#### Single marker analysis (SMA)

```{r}
maize.mr <- scanone(maize.mds. pheno.col = "PlantHeight", method = "mr")
summary(maize.mr, threshold = lod.mr)
plot(maize.mr, type = "p", main = "Single marker analysis (SMA)")
abline(h = lod.mr)
```

#### Interval mapping (IM)

```{r}
maize.mds <- calc.genoprob(cross = maize.mds, step = 1)
```

```{r}
maize.im <- scanone(cross = maize.mds, pheno.col = "PlantHeight", method = "hk")
summary(maize.im, threshold = lod.im)
plot(maize.im, col = "blue", main = "Interval mapping (IM)")
abline(h = lod.im)
```

#### Composite interval mapping (CIM)

```{r}
maize.cim10 <- cim(cross = maize.mds, pheno.col = "PlantHeight", method = "hk", n.marcovar = 20, window =10)
(maize.cim.sig <- summary(maize.cim10, threshold = lod.cim))
plot(maize.cim10, col = "red", main = "Composite interval mapping (CIM)")
abline(h = lod.cim)
```

```{r}
maize.mds <- sim.geno(maize.mds, step = 1)
maize.cim.qtl <- makeqtl(cross = maize.mds, chr = maize.cim.sig$chr, pos = maize.cim.sig$pos)
maize.cim.qtl
```

```{r}
formula <- as.formula(paste("y", paste0("Q",c(1:length(maize.cim.sig$pos)), collapse = "+"))
maize.cim.fit <- fitqtl(cross= maize.mds, pheno.col = "PlantHeight", qtl= maize.cim.qtl, formula = formula, get.ests = TRUE)
summary(maize.cim.fit)
```

#### MIM

```{r}
maize.step <- stepwise(maize.mds, pheno.col "PlantHeight", max.qtl = 6, method = "hk", penalties = penalties.mim)
summary(maize.step)
plotLodProfile(maize.step, main ="PlantHeight")
```

```{r}
maize.mds <- sim.geno(maize.mds, step = 5)
maize.two <- scantwo(maize.mds, pheno.col = "PlantHeight", method = "hk")
save(maize.two, file = "maize_two.RData")
```

```{r}
plot(maize.two, col.scheme = "redblue")
summary(maize.two)
```

## Discussion

## Conclusion

## References

```{r}
load("maize15_mds.Rdata")
```

```{r}
maize <- calc.genoprob(maize, step = 1)
```

```{r}
maize.perm.em <- scanone(maize, pheno.col = "PlantHeight", method = "em", n.perm = 1000, verbose = FALSE)
maize.perm.hk <- scanone(maize, pheno.col = "PlantHeight", method = "hk", n.perm = 1000, verbose = FALSE)
```

```{r}
summary(maize.perm.em, alpha = 0.05)
summary(maize.perm.hk, alpha = 0.05)
```

```{r}
maize.em <- scanone(maize, pheno.col = "PlantHeight", method = "em")
maize.hk <- scanone(maize, pheno.col = "PlantHeight", method = "hk")
```

```{r}
summary(maize.em, perms = maize.perm.em, alpha = 0.05)
summary(maize.hk, perms = maize.perm.hk, alpha = 0.05)
```

```{r}
plot(maize.em, maize.hk, ylab = "LOD score", main = "PlantHeight", col = c("red", "blue"), lwd = 3)
add.threshold(maize.em, perms = maize.perm.em, col = "red")
add.threshold(maize.hk, perms = maize.perm.hk, col = "blue")
legend("topright", legend = c("EM", "HK"), lty = 1, lwd = 3, col = c("red", "blue"))
```
